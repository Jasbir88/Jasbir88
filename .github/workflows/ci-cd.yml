name: CI/CD Pipeline

on:
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main
      - develop
  schedule:
    - cron: '0 23 * * 1,5'  # Every Monday and Friday at 11PM UTC
  workflow_dispatch:
    inputs:
      deploy_environment:
        description: 'Environment to deploy to'
        required: false
        default: 'staging'
        type: choice
        options:
          - staging
          - production

permissions:
  contents: write
  actions: read
  pull-requests: write
  pages: write
  id-token: write

env:
  NODE_VERSION: '20'
  PYTHON_VERSION: '3.11'

jobs:
  # ============================================
  # Detect Changes
  # ============================================
  detect-changes:
    name: üîç Detect Changes
    runs-on: ubuntu-latest
    outputs:
      python: ${{ steps.filter.outputs.python }}
      javascript: ${{ steps.filter.outputs.javascript }}
      bash: ${{ steps.filter.outputs.bash }}
      docker: ${{ steps.filter.outputs.docker }}
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Detect File Changes
        uses: dorny/paths-filter@v2
        id: filter
        with:
          filters: |
            python:
              - '**/*.py'
              - 'requirements*.txt'
              - 'setup.py'
              - 'pyproject.toml'
            javascript:
              - '**/*.js'
              - '**/*.ts'
              - '**/*.jsx'
              - '**/*.tsx'
              - 'package*.json'
              - 'tsconfig.json'
            bash:
              - '**/*.sh'
              - '**/*.bash'
            docker:
              - 'Dockerfile*'
              - 'docker-compose*.yml'
              - '.dockerignore'

  # ============================================
  # Python Linting and Testing
  # ============================================
  python-lint-test:
    name: üêç Python Lint & Test
    runs-on: ubuntu-latest
    needs: detect-changes
    if: |
      needs.detect-changes.outputs.python == 'true' ||
      github.event_name == 'workflow_dispatch' ||
      github.event_name == 'schedule'
    strategy:
      matrix:
        python-version: ['3.10', '3.11', '3.12']
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Cache Python Dependencies
        uses: actions/cache@v3
        with:
          path: |
            ~/.cache/pip
            .venv
          key: ${{ runner.os }}-pip-${{ matrix.python-version }}-${{ hashFiles('**/requirements*.txt', '**/pyproject.toml') }}
          restore-keys: |
            ${{ runner.os }}-pip-${{ matrix.python-version }}-
            ${{ runner.os }}-pip-

      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip setuptools wheel

          # Check if requirements.txt exists
          if [ -f "requirements.txt" ]; then
            echo "üì¶ Installing from requirements.txt..."
            pip install -r requirements.txt
          fi

          # Install dev dependencies if they exist
          if [ -f "requirements-dev.txt" ]; then
            echo "üì¶ Installing dev dependencies..."
            pip install -r requirements-dev.txt
          else
            # Install common testing tools
            pip install pytest pytest-cov flake8 black isort
          fi

      - name: Lint with Flake8
        run: |
          if [ -f ".flake8" ] || [ -f "setup.cfg" ] || [ -f "tox.ini" ]; then
            echo "üîç Running Flake8..."
            flake8 . || echo "::warning::Flake8 found issues"
          else
            echo "‚è≠Ô∏è No Flake8 configuration found, skipping..."
          fi

      - name: Format Check with Black
        run: |
          if [ -f "pyproject.toml" ] || [ -f ".black" ]; then
            echo "üé® Checking Black formatting..."
            black --check . || echo "::warning::Black formatting issues found"
          else
            echo "‚è≠Ô∏è No Black configuration found, skipping..."
          fi

      - name: Run Tests
        run: |
          if [ -d "tests" ] || [ -d "test" ]; then
            echo "üß™ Running tests with pytest..."
            pytest -v --cov=. --cov-report=xml --cov-report=html || echo "::warning::Some tests failed"
          else
            <span class="ml-2" /><span class="inline-block w-3 h-3 rounded-full bg-neutral-a12 align-middle mb-[0.1rem]" />
